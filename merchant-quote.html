<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Funding Proposal</title>
<style>
:root{ --gold:#d09c34; --bg:#101424; --panel:#12182c; --muted:#0f1426; --text:#ffffff; --sub:rgba(255,255,255,.70); --border:rgba(255,255,255,.10); --radius:16px; --shadow:0 12px 30px rgba(0,0,0,.35); }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);color:var(--sub)}
.container{max-width:1100px;margin:18px auto 40px;padding:0 16px;display:grid;grid-template-columns:1fr;gap:20px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
.card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:18px;display:flex;align-items:center;justify-content:space-between}
.card .content{padding:16px}
.statgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.stat{background:var(--muted);border:1px solid var(--border);border-radius:14px;padding:14px}
.stat .k{font-size:12px;color:var(--sub)}
.stat .v{font-size:22px;font-weight:800;margin-top:6px}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(16,20,36,.6);border:1px solid var(--border);color:var(--sub);font-size:12px}
.table-wrap{max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px}
/* Make Early Payoff table narrower on wide screens */
.table-wrap.payoff-narrow{max-width:720px;margin:0 auto}
@media(max-width:820px){.table-wrap.payoff-narrow{max-width:100%}}
th,td{text-align:right;padding:10px 8px;border-bottom:1px solid var(--border);font-variant-numeric:tabular-nums}
th:first-child,td:first-child{text-align:left}
.btn{cursor:pointer;background:linear-gradient(180deg,var(--gold),#b5862e);color:#111;border:none;border-radius:10px;padding:10px 14px;font-weight:700;box-shadow:0 8px 22px rgba(208,156,52,.28)}
.btn.sec{background:transparent;border:1px solid var(--border);color:#fff;box-shadow:none}
.small{font-size:12px;color:var(--sub)}
.note{background:rgba(208,156,52,.08);border:1px solid rgba(208,156,52,.35);border-radius:12px;padding:12px;color:#fff}
.disc{font-size:12px;color:var(--sub);margin-top:10px;line-height:1.4}
@media(max-width:980px){.statgrid{grid-template-columns:1fr}}
</style>

<!-- Plausible Analytics (optional) -->
<script defer data-domain="dylg01.github.io"
  src="https://plausible.io/js/script.file-downloads.hash.outbound-links.pageview-props.revenue.tagged-events.js"></script>
<script>window.plausible = window.plausible || function(){ (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
</head>
<body>
<header>
  <div><strong>Funding Proposal</strong> <span class="pill" id="dealBadge">—</span></div>
  <div style="display:flex;gap:8px;align-items:center;">
    <div class="small" id="freqBadge">—</div>
    <button class="btn sec" id="copyLink" type="button">Copy Link</button>
    <button class="btn sec" id="printBtn" type="button">Print</button>
  </div>
</header>

<div class="container">
  <div class="card">
    <h2>Your Offer</h2>
    <div class="content">
      <div class="statgrid">
        <div class="stat"><div class="k">Funding Amount</div><div class="v" id="advOut">$0</div></div>
        <div class="stat"><div class="k">Total Payback</div><div class="v" id="paybackOut">$0</div></div>
        <div class="stat"><div class="k">Payment</div><div class="v" id="payOut">$0</div><div class="small" id="payMeta">—</div></div>
      </div>
      <div class="statgrid" style="margin-top:12px;">
        <div class="stat"><div class="k">Estimated # of Payments</div><div class="v" id="countOut">0</div></div>
        <div class="stat"><div class="k">Approx. Term</div><div class="v" id="monthsOut">0 mo</div></div>
        <div class="stat"><div class="k">Net to You (after fees/holdbacks)</div><div class="v" id="netOut">$0</div></div>
      </div>
      <div class="disc">This is a proposal for discussion purposes and is not a commitment to fund. Final terms subject to underwriting and documentation.</div>
    </div>
  </div>

  <div class="card">
    <h2>Early Payoff Savings</h2>
    <div class="content">
      <div class="table-wrap payoff-narrow">
        <table style="width:25%;border-collapse:collapse;">
          <thead><tr><th>Month</th><th>You Save</th><th>Payoff</th></tr></thead>
          <tbody id="ppBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="./codec.js"></script>
<script>
'use strict';
const fmt  = (n)=> n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const fmt0 = (n)=> n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
const autoTierFee=(A)=>{ A=+A||0; if(A<=0) return 0; if(A<=9999) return 350; if(A<=14999) return 450; if(A<=18999) return 550; return +(A*0.03).toFixed(2); };
function tryDecodeQ(q){ try{ if(window.Codec){ const txt=Codec.decode(q); return JSON.parse(txt); } }catch(e){} try{ let b64=q.replace(/-/g,'+').replace(/_/g,'/'); b64=b64 + '==='.slice((4 - b64.length % 4) % 4); const bin=atob(b64); const bytes=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i); const txt=new TextDecoder().decode(bytes); return JSON.parse(txt); }catch(e){} try{ const b64=decodeURIComponent(q); const bin=atob(b64); const bytes=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i); const txt=new TextDecoder().decode(bytes); return JSON.parse(txt); }catch(e){} return null; }

const params = new URLSearchParams(location.search); const q=params.get('q'); let data=null; if(q){ data=tryDecodeQ(q); }
if(!data && !q){ try{ data=JSON.parse(localStorage.getItem('pwfQQData')||'null'); }catch(e){ data=null; } }
if(!data || !Number.isFinite(+data.advance)){
  document.body.innerHTML = '<div style="padding:24px;font-family:system-ui;color:#fff;background:#101424">We could not load the proposal. Please use the latest link from your representative.</div>';
  throw new Error('No usable data');
}

// Seed
const name=data.name||''; const A=+data.advance||0; const buy=+data.buyRate||1.2; const sell=Math.max(+data.sellRate||buy,buy); const isoPct=Math.round(+data.isoPct||0); const hold=+data.holdback||0; const freq=(data.frequencyMain==='daily')?'Daily':'Weekly'; const payback=A*sell; const fee=autoTierFee(A); const net=Math.max(0, A - fee - hold);
const basePeriods = (Number.isFinite(+data.basePeriods)&&+data.basePeriods>0) ? +data.basePeriods : NaN; const monthsBase=(Number.isFinite(+data.monthsBase)&&+data.monthsBase>0) ? +data.monthsBase : 1; const prepayRates = Array.isArray(data.prepayRates)? data.prepayRates : []; const maxM=Math.max(1, Math.min(12, +data.maxPrepayMonths || prepayRates.length || 4));

// Payment calc (uses basePeriods from main)
let payment=0; if(Number.isFinite(basePeriods)&&basePeriods>0){ payment = payback / basePeriods; } else { const monthly = payback / (monthsBase>0?monthsBase:1); const daily = monthly / 21; const weekly = daily*5; payment = (freq==='Weekly') ? weekly : daily; }
payment = Math.max(1, Math.round(payment));
let count=0, finalPay=0, monthsEst=0; if(payment>0 && payback>0){ count=Math.ceil(payback/payment); finalPay=Math.max(0, Math.round(payback - payment*(count-1))); monthsEst=(freq==='Weekly')?((payback/payment)/4.33):((payback/payment)/21); }

// Fill UI
if(name) document.title = 'Funding Proposal — ' + name; document.getElementById('dealBadge').textContent = name||'—'; document.getElementById('freqBadge').textContent = freq; document.getElementById('advOut').textContent=fmt(A); document.getElementById('paybackOut').textContent=fmt(payback); document.getElementById('payOut').textContent = fmt0(payment) + ' (final ' + fmt0(finalPay) + ')'; document.getElementById('payMeta').textContent = freq + ' fixed'; document.getElementById('countOut').textContent = String(count); document.getElementById('monthsOut').textContent = monthsEst.toFixed(2) + ' mo'; document.getElementById('netOut').textContent=fmt(net);

// Prepay table (merchant framing: savings vs full payback)
const ppBody=document.getElementById('ppBody'); ppBody.innerHTML=''; for(let m=1;m<=maxM;m++){ const rate = +(prepayRates[m-1] ?? sell); const payoff = +(A*rate).toFixed(2); const save = +(payback - payoff).toFixed(2); const tr=document.createElement('tr'); tr.innerHTML = `<td>${m}</td><td>${fmt(save)}</td><td>${fmt(payoff)}</td>`; ppBody.appendChild(tr); }

// Share + print
const shareInput = document.getElementById('copyLink'); shareInput.addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText(location.href); shareInput.textContent='Copied'; setTimeout(()=>shareInput.textContent='Copy Link',1000); }catch(e){ alert('Copy failed. You can copy the URL from the address bar.'); } });
document.getElementById('printBtn').addEventListener('click',()=>window.print());

// Analytics: mark merchant view
window.plausible && window.plausible('Merchant View', {props:{source: params.get('q') ? 'link' : 'fallback'}});
</script>
</body>
</html>
