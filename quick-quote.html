<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PWF — Quick Quote</title>
<style>
:root{ --gold:#d09c34; --bg:#101424; --panel:#12182c; --muted:#0f1426; --text:#ffffff; --sub:rgba(255,255,255,.70); --border:rgba(255,255,255,.10); --danger:#ff5a5a; --radius:16px; --shadow:0 12px 30px rgba(0,0,0,.35); }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);color:var(--sub)}
.container{max-width:1100px;margin:18px auto 40px;padding:0 16px;display:grid;grid-template-columns:420px 1fr;gap:20px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
.card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:18px;display:flex;align-items:center;justify-content:space-between}
.card .content{padding:16px}
label{display:block;font-size:12px;color:var(--sub);margin:10px 0 6px}
input{width:100%;background:rgba(16,20,36,.6);border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px;font-size:14px;outline:none}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(16,20,36,.6);border:1px solid var(--border);color:var(--sub);font-size:12px}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.stat{background:var(--muted);border:1px solid var(--border);border-radius:14px;padding:14px}
.stat .k{font-size:12px;color:var(--sub)}
.stat .v{font-size:18px;font-weight:700;margin-top:6px}
.table-wrap{max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:12px}
th,td{text-align:right;padding:10px 8px;border-bottom:1px solid var(--border);font-variant-numeric:tabular-nums}
th:first-child,td:first-child{text-align:left}
.btn{cursor:pointer;background:linear-gradient(180deg,var(--gold),#b5862e);color:#111;border:none;border-radius:10px;padding:10px 14px;font-weight:700;box-shadow:0 8px 22px rgba(208,156,52,.28)}
.btn.sec{background:transparent;border:1px solid var(--border);color:#fff;box-shadow:none}
.small{font-size:12px;color:var(--sub)}
.share{display:flex;gap:8px;align-items:center;margin-left:8px}
.share input{flex:1}
@media(max-width:980px){.container{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div><strong id="qqDealHeader">Deal:</strong> <span class="pill" id="qqDealBadge">—</span></div>
  <div style="display:flex;gap:8px;align-items:center;">
    <span class="pill" id="qqFreq">—</span>
    <div class="share">
      <input id="shareUrl" readonly>
      <button class="btn sec" id="copyShare">Copy Link</button>
    </div>
    <button class="btn sec" id="qqBack" type="button">Close</button>
    <button class="btn" id="qqPrint" type="button">Print</button>
  </div>
</header>

<div class="container">
  <div class="card">
    <h2>Approved Range <span class="small" id="qqExp" style="opacity:.85"></span></h2>
    <div class="content">
      <div class="stat">
        <div class="k">Range (locked from Main)</div>
        <div class="v" id="qqRange">$5,000 – $0</div>
      </div>

      <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
        <div>
          <label>Advance (max = Main)</label>
          <input type="number" id="adv" min="0" step="100" value="0" />
        </div>
        <div>
          <label>ISO Commission (%)</label>
          <input type="number" id="isoPct" min="0" max="12" step="1" value="12" />
        </div>
      </div>

      <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
        <div>
          <label>Sell Rate (factor)</label>
          <input type="number" id="sell" step="0.01" min="1" />
        </div>
        <div>
          <label>Buy Rate (factor)</label>
          <input type="number" id="buy" step="0.01" min="1" disabled />
        </div>
      </div>

      <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
        <div>
          <label>Holdback ($) (from Main)</label>
          <div class="stat"><div class="k">Holdback</div><div class="v" id="qqHold">$0</div></div>
        </div>
        <div>
          <label>Fee ($) — Auto-tier</label>
          <input type="number" id="qqFeeBox" value="0" disabled />
          <div class="small">Tier: $5k–9,999 → $350 • $10k–14,999 → $450 • $15k–18,999 → $550 • $19k+ → 3%</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Quote Summary</h2>
    <div class="content">
      <div class="stats">
        <div class="stat"><div class="k">Merchant Payback</div><div class="v" id="payOut">$0</div></div>
        <div class="stat"><div class="k">Net Funded</div><div class="v" id="netOut">$0</div></div>
        <div class="stat"><div class="k">ISO Commission $</div><div class="v" id="isoOut">$0</div></div>
      </div>

      <div class="stats" style="margin-top:12px;">
        <div class="stat"><div class="k">Payment Amount</div><div class="v" id="qqPayAmt">$0</div><div class="small">Uses base periods from Main</div></div>
        <div class="stat"><div class="k">Total Payments</div><div class="v" id="qqTot">0</div><div class="small">Count + ≈ months</div></div>
        <div class="stat"><div class="k">Frequency</div><div class="v" id="qqFreqDup">—</div><div class="small">Locked from Main</div></div>
      </div>

      <div style="margin-top:18px;">
        <h3 style="margin:0 0 8px 0; font-size:16px;">Prepay Scenarios</h3>
        <div class="table-wrap">
          <table style="width:100%;border-collapse:collapse;">
            <thead><tr><th>Month</th><th>Estimated Discount</th><th>Payoff</th><th>Sell Rate</th></tr></thead>
            <tbody id="qqPpBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="./codec.js"></script>
<script>
'use strict';
const fmt  = (n)=> n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const fmt0 = (n)=> n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
const autoTierFee=(A)=>{ A=+A||0; if(A<=0) return 0; if(A<=9999) return 350; if(A<=14999) return 450; if(A<=18999) return 550; return +(A*0.03).toFixed(2); };

// Elements
const adv=document.getElementById('adv');
const isoPct=document.getElementById('isoPct');
const sell=document.getElementById('sell');
const buy=document.getElementById('buy');
const payOut=document.getElementById('payOut');
const netOut=document.getElementById('netOut');
const isoOut=document.getElementById('isoOut');
const rangeEl=document.getElementById('qqRange');
const ppBody=document.getElementById('qqPpBody');
const qqTot=document.getElementById('qqTot');
const qqPayAmt=document.getElementById('qqPayAmt');
const qqHold=document.getElementById('qqHold');
const feeBox=document.getElementById('qqFeeBox');
const freqLabelEl=document.getElementById('qqFreq');
const freqDup=document.getElementById('qqFreqDup');

// ------- Robust decode for ?q= payload (handles Codec, URL-safe b64, or URL-encoded b64) -------
function tryDecodeQ(q){
  // 1) If codec.js is present
  try{ if(window.Codec){ const txt = Codec.decode(q); return JSON.parse(txt); } }catch(e){}
  // 2) Try URL-safe base64 without padding
  try{
    let b64 = q.replace(/-/g,'+').replace(/_/g,'/');
    b64 = b64 + '==='.slice((4 - b64.length % 4) % 4);
    const bin = atob(b64);
    const bytes = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
    const txt = new TextDecoder().decode(bytes);
    return JSON.parse(txt);
  }catch(e){}
  // 3) Try URL-encoded standard base64
  try{
    const b64 = decodeURIComponent(q);
    const bin = atob(b64);
    const bytes = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
    const txt = new TextDecoder().decode(bytes);
    return JSON.parse(txt);
  }catch(e){}
  return null;
}

const params = new URLSearchParams(location.search);
const q = params.get('q');
let data=null;
if(q){ data = tryDecodeQ(q); }

// Only use localStorage if NO q present. Never silently override a bad link with stale local data.
if(!data && !q){
  try{ data = JSON.parse(localStorage.getItem('pwfQQData')||'null'); }catch(e){ data=null; }
}

if(!data || !Number.isFinite(+data.advance)){
  document.body.innerHTML = '<div style="padding:24px;font-family:system-ui;color:#fff;background:#101424">Quote link could not be read. Please reopen from the main calculator (Copy Quote Link). If this persists, make sure <code>codec.js</code> is deployed next to this file.</div>';
  throw new Error('No usable data');
}

// Seed values from payload
const name = data.name||'';
const mainAdvance = +data.advance||0;
const buyInit = +data.buyRate||1.2;
const sellInit = Math.max(+data.sellRate||buyInit, buyInit);
const isoInit = Math.round(+data.isoPct||0);
const holdback = +data.holdback||0;
const expISO = data.expDateISO || '';
const freqLabelMain = (data.frequencyMain==='daily')?'Daily':'Weekly';
const prepayRates = Array.isArray(data.prepayRates)? data.prepayRates : [];
const maxM = Math.max(1, Math.min(12, +data.maxPrepayMonths || prepayRates.length || 4));
const basePeriods = (Number.isFinite(+data.basePeriods)&&+data.basePeriods>0) ? +data.basePeriods : NaN;
const monthsBase = (Number.isFinite(+data.monthsBase)&&+data.monthsBase>0) ? +data.monthsBase : 1;

// Header/UI seeds
const header = document.getElementById('qqDealHeader');
header.textContent = 'Deal: ' + (name||'');
document.getElementById('qqDealBadge').textContent = name || '—';
freqLabelEl.textContent = freqLabelMain;  
document.getElementById('qqExp').textContent = expISO ? ('Expires: '+expISO) : '';
adv.value = String(mainAdvance);
isoPct.value = String(isoInit);
sell.value = sellInit.toFixed(2);
buy.value = buyInit.toFixed(2);
qqHold.textContent = fmt0(holdback);
rangeEl.textContent = '$5,000 – ' + fmt(mainAdvance);
freqDup.textContent = freqLabelMain;

// Share box
const shareUrl = document.getElementById('shareUrl');
shareUrl.value = location.href;
document.getElementById('copyShare').addEventListener('click', async()=>{
  try{ await navigator.clipboard.writeText(shareUrl.value); document.getElementById('copyShare').textContent='Copied'; setTimeout(()=>document.getElementById('copyShare').textContent='Copy Link',1000);}catch(e){ shareUrl.select(); document.execCommand('copy'); }
});

let userEditingSell=false;
sell.addEventListener('focus', ()=>{ userEditingSell=true; });
sell.addEventListener('blur', ()=>{ userEditingSell=false; let v=parseFloat(sell.value); if(!Number.isFinite(v)) v=buyInit; if(v<buyInit) v=buyInit; sell.value=v.toFixed(2); render(); });

function render(){
  let A = +adv.value || 0; if(A>mainAdvance){ A=mainAdvance; adv.value=String(mainAdvance); }
  let pct = Math.round(+isoPct.value||0); if(pct<0) pct=0; if(pct>100) pct=100; isoPct.value=String(pct);

  // Tiered fee
  const fee = autoTierFee(A); feeBox.value = String(fee);

  // ISO↔Sell coupling (±0.01 per 1% ISO change)
  const deltaPct = pct - isoInit;
  const coupledSell = +(sellInit + (deltaPct * 0.01)).toFixed(2);
  if(!userEditingSell){ sell.value = Math.max(coupledSell, buyInit).toFixed(2); }
  let sr = +sell.value; if(!Number.isFinite(sr)) sr=buyInit; if(!userEditingSell && sr<buyInit){ sr=buyInit; sell.value=sr.toFixed(2); }

  // Core calcs
  const payback = A*sr; const iso$ = A*(pct/100);
  const net = Math.max(0, A - fee - holdback);
  payOut.textContent=fmt(payback); netOut.textContent=fmt(net); isoOut.textContent=fmt(iso$);

  // Payment via basePeriods from Main
  let paymentCalc = 0;
  if(Number.isFinite(basePeriods) && basePeriods>0){
    paymentCalc = payback / basePeriods; // basePeriods = (Advance×Sell)/payment from Main
  } else {
    const monthly = payback / (monthsBase>0?monthsBase:1);
    const daily = monthly / 21; const weekly = daily*5;
    paymentCalc = (freqLabelMain==='Weekly') ? weekly : daily;
  }
  const payment = Math.max(1, Math.round(paymentCalc));

  // Counts / final / months
  let count=0, finalPay=0, monthsEst=0;
  if(payment>0 && payback>0){
    count = Math.ceil(payback / payment);
    finalPay = Math.max(0, Math.round(payback - payment*(count-1)));
    monthsEst = (freqLabelMain==='Weekly') ? ((payback/payment)/4.33) : ((payback/payment)/21);
  }
  qqPayAmt.textContent = payment>0 ? (fmt0(payment) + ' (final ' + fmt0(finalPay) + ')') : '$0';
  qqTot.textContent = count ? (String(count) + ' (≈ ' + monthsEst.toFixed(2) + ' mo)') : '0';

  // Prepay table — shift each month rate by deltaPct*0.01 against baseline inputs
  ppBody.innerHTML='';
  for(let m=1;m<=maxM;m++){
    const baseRate = +( (prepayRates[m-1] ?? sr) );
    let rate = baseRate + (deltaPct * 0.01); if(rate<1) rate=1;
    const payoffM = +(A*rate).toFixed(2);
    const disc = +(payback - payoffM).toFixed(2);
    const tr=document.createElement('tr');
    tr.innerHTML = '<td>Month '+m+'</td><td>'+fmt(disc)+'</td><td>'+fmt(payoffM)+'</td><td>'+rate.toFixed(2)+'</td>';
    ppBody.appendChild(tr);
  }
}

['input','change','blur'].forEach(ev=>{ adv.addEventListener(ev,render); isoPct.addEventListener(ev,render); sell.addEventListener(ev,render); });
document.getElementById('qqBack').addEventListener('click',()=>{ window.close(); });
document.getElementById('qqPrint').addEventListener('click',()=>{ window.print(); });

render();
</script>
</body>
</html>
