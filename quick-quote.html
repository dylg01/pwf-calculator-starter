<!DOCTYPE html>
const ppBody=document.getElementById('qqPpBody');
const qqTot=document.getElementById('qqTot');
const qqPayAmt=document.getElementById('qqPayAmt');
const qqHold=document.getElementById('qqHold');
const feeBox=document.getElementById('qqFeeBox');
const freqLabelEl=document.getElementById('qqFreq');


// Set static/defaults
document.getElementById('qqDealHeader').textContent = 'Deal: ' + name;
document.getElementById('qqDealBadge').textContent = name || '—';
freqLabelEl.textContent = freqLabelMain;
adv.value = String(mainAdvance);
isoPct.value = String(isoInit);
sell.value = sellInit.toFixed(2);
buy.value = buyInit.toFixed(2);
qqHold.textContent = fmt0(holdback);
rangeEl.textContent = '$5,000 – ' + fmt(mainAdvance);


let userEditingSell=false;
sell.addEventListener('focus', ()=>{ userEditingSell=true; });
sell.addEventListener('blur', ()=>{ userEditingSell=false; let v=parseFloat(sell.value); if(!Number.isFinite(v)) v=buyInit; if(v<buyInit) v=buyInit; sell.value=v.toFixed(2); render(); });


function render(){
let A = +adv.value || 0; if(A>mainAdvance){ A=mainAdvance; adv.value=String(mainAdvance); }
let pct = Math.round(+isoPct.value||0); if(pct<0) pct=0; if(pct>100) pct=100; isoPct.value=String(pct);


// Tiered fee
const fee = autoTierFee(A); feeBox.value = String(fee);


// ISO↔Sell coupling (±0.01 per 1% ISO change)
const deltaPct = pct - isoInit;
const coupledSell = +(sellInit + (deltaPct * 0.01)).toFixed(2);
if(!userEditingSell){ sell.value = Math.max(coupledSell, buyInit).toFixed(2); }
let sr = +sell.value; if(!Number.isFinite(sr)) sr=buyInit; if(!userEditingSell && sr<buyInit){ sr=buyInit; sell.value=sr.toFixed(2); }


// Core calcs
const payback = A*sr; const iso$ = A*(pct/100);
const net = Math.max(0, A - fee - holdback);
payOut.textContent=fmt(payback); netOut.textContent=fmt(net); isoOut.textContent=fmt(iso$);


// Payment via basePeriods
let paymentCalc = 0;
if(Number.isFinite(basePeriods) && basePeriods>0){
paymentCalc = payback / basePeriods; // your method
} else {
// Fallback: derive from monthsBase‑like estimate
const monthsBase = (+data.monthsBase>0)? +data.monthsBase : 1;
const monthly = payback / monthsBase;
const daily = monthly / 21; const weekly = daily*5;
paymentCalc = (freqLabelMain==='Weekly') ? weekly : daily;
}
const payment = Math.max(1, Math.round(paymentCalc));


// Counts / final / months
let count=0, finalPay=0, monthsEst=0;
if(payment>0 && payback>0){
count = Math.ceil(payback / payment);
finalPay = Math.max(0, Math.round(payback - payment*(count-1)));
monthsEst = (freqLabelMain==='Weekly') ? ((payback/payment)/4.33) : ((payback/payment)/21);
}
qqPayAmt.textContent = payment>0 ? (fmt0(payment) + ' (final ' + fmt0(finalPay) + ')') : '$0';
qqTot.textContent = count ? (String(count) + ' (≈ ' + monthsEst.toFixed(2) + ' mo)') : '0';


// Prepay table — shift each month rate by deltaPct*0.01 against baseline inputs
ppBody.innerHTML='';
for(let m=1;m<=maxM;m++){
const baseRate = +( (prepayRates[m-1] ?? sr) );
let rate = baseRate + (deltaPct * 0.01); if(rate<1) rate=1;
const payoffM = +(A*rate).toFixed(2);
const disc = +(payback - payoffM).toFixed(2);
const tr=document.createElement('tr');
tr.innerHTML = '<td>Month '+m+'</td><td>'+fmt(disc)+'</td><td>'+fmt(payoffM)+'</td><td>'+rate.toFixed(2)+'</td>';
ppBody.appendChild(tr);
}
}


['input','change','blur'].forEach(ev=>{
adv.addEventListener(ev,render); isoPct.addEventListener(ev,render); sell.addEventListener(ev,render);
});
document.getElementById('qqBack').addEventListener('click',()=>{ window.close(); });
document.getElementById('qqPrint').addEventListener('click',()=>{ window.print(); });


render();
</script>
</body>
</html>