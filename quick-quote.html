<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Quick Quote — Pac Western</title>
<style>
:root{ --gold:#d09c34; --bg:#101424; --text:#fff; --panel:#12182c; --border:rgba(255,255,255,.10); --sub:rgba(255,255,255,.70); --radius:16px; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;font-family: ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial;}
header{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)}
.brand{font-weight:800;letter-spacing:.4px;color:#d09c34}
.deal{font-size:12px;color:#9bb;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
.wrap{max-width:940px;margin:18px auto 28px;padding:0 16px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius)}
.card h2{margin:0;padding:16px 20px;border-bottom:1px solid var(--border);font-size:18px;display:flex;justify-content:space-between;align-items:center}
.content{padding:18px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.stat{background:rgba(16,20,36,.6);border:1px solid var(--border);border-radius:12px;padding:14px;position:relative}
.k{font-size:12px;color:#9bb}
.v{font-size:18px;font-weight:700;margin-top:6px}
.ibox{width:100%;background:rgba(16,20,36,.6);border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px;font-size:16px}
.sm{font-size:12px;color:#9bb;margin-top:6px}
table{width:100%;border-collapse:collapse;margin-top:14px}
th,td{text-align:right;padding:8px;border-bottom:1px solid var(--border);font-variant-numeric:tabular-nums}
th:first-child,td:first-child{text-align:left}
.bar{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.btn{cursor:pointer;background:linear-gradient(180deg,var(--gold),#b5862e);color:#111;border:none;border-radius:10px;padding:10px 14px;font-weight:700}
.btn.sec{background:transparent;color:#fff;border:1px solid var(--border)}
.exp-chip{position:absolute; right:12px; top:10px; font-size:12px; color:#9bb;}
.lock{position:absolute; right:12px; top:10px; font-size:12px; color:#9bb;}
@media (max-width:860px){ .grid3{grid-template-columns:1fr 1fr} .grid4{grid-template-columns:1fr 1fr} }
@media print{ .btn{display:none} header{display:none} }
</style>
</head>
<body>
<header>
  <div class="brand">Pac Western Financial</div>
  <div class="deal" id="qqDealHeader"></div>
</header>

<div class="wrap">
  <div class="card">
    <h2>Quick Quote <span class="deal" id="qqDealBadge"></span></h2>
    <div class="content">
      <div class="stat" style="margin-bottom:12px;">
        <div class="k">Approved Range</div>
        <div class="exp-chip" id="qqExp"></div>
        <div class="v"><span id="qqRange"></span></div>
        <div class="k" style="margin-top:4px;color:#6f8ca8">(Locked to main page)</div>
      </div>

      <div class="grid4">
        <div class="stat">
          <div class="k">Advance Amount ($)</div>
          <div><input class="ibox" type="number" id="qqAdvance" step="100" min="5000" /></div>
        </div>
        <div class="stat">
          <div class="k">ISO Commission (%)</div>
          <div><input class="ibox" type="number" id="qqIsoPct" step="1" min="0" max="100" /></div>
        </div>
        <div class="stat" style="position:relative;">
          <div class="k">Sell Rate</div>
          <div class="lock">Auto-coupled to ISO</div>
          <div><input class="ibox" type="number" id="qqSell" step="0.01" min="1" /></div>
        </div>
        <div class="stat">
          <div class="k">Buy Rate</div>
          <div><input class="ibox" type="number" id="qqBuy" step="0.01" min="1" disabled /></div>
        </div>
      </div>

      <div class="grid4" style="margin-top:12px;">
        <div class="stat">
          <div class="k">Fee ($)</div>
          <div><input class="ibox" type="number" id="qqFeeBox" step="1" min="0" disabled /></div>
          <div class="sm">Locked to 3% of Advance</div>
        </div>
        <div class="stat">
          <div class="k">Holdback</div>
          <div class="v" id="qqHold">$0</div>
        </div>
        <div class="stat">
          <div class="k">Payment Amount (<span id="qqFreq"></span>)</div>
          <div class="v" id="qqPayAmt">$0</div>
        </div>
        <div class="stat">
          <div class="k">Total Payments</div>
          <div class="v" id="qqTot">0</div>
        </div>
      </div>

      <div class="grid3" style="margin-top:12px;">
        <div class="stat"><div class="k">Merchant Payback (A × SR)</div><div class="v" id="qqPayback">$0</div></div>
        <div class="stat"><div class="k">Net Funded</div><div class="v" id="qqNet">$0</div></div>
        <div class="stat"><div class="k">ISO Commission $ (A × %)</div><div class="v" id="qqIso">$0</div></div>
      </div>

      <h3 style="margin:16px 0 8px;">Prepay Scenarios</h3>
      <table>
        <thead><tr><th>Scenario</th><th>Estimated Discount</th><th>Payoff</th><th>Sell Rate</th></tr></thead>
        <tbody id="qqPpBody"></tbody>
      </table>

      <div class="bar">
        <button class="btn sec" id="qqBack">Back</button>
        <button class="btn" id="qqPrint">Print</button>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';

const fmt  = (n)=> n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const fmt0 = (n)=> n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
const mmddyyyy = (iso)=>{
  const p=(iso||'').split('-'); if(p.length===3) return p[1]+'/'+p[2]+'/'+p[0]; return iso||'';
};
const fee3pct = (A)=> +(A*0.03).toFixed(2);

const dataRaw = sessionStorage.getItem('pwfQQData');
if(!dataRaw){
  document.body.innerHTML = '<div style="padding:24px;font-family:ui-sans-serif">No Quick Quote data found. Open this page via the main calculator.</div>';
} else {
  const D = JSON.parse(dataRaw);

  // Header bits
  document.title = 'Quick Quote — ' + (D.name||'');
  document.getElementById('qqDealHeader').textContent = 'Deal: ' + (D.name||'—');
  document.getElementById('qqDealBadge').textContent  = D.name || '—';
  document.getElementById('qqExp').textContent = mmddyyyy(D.expDateISO);
  document.getElementById('qqFreq').textContent = (D.frequencyMain==='weekly'?'Weekly':'Daily');

  // Approved range LOCKED to main advance
  document.getElementById('qqRange').textContent = '$5,000 – ' + fmt(D.advance);

  // Inputs
  const adv   = document.getElementById('qqAdvance');
  const isoPt = document.getElementById('qqIsoPct');
  const sell  = document.getElementById('qqSell');
  const buy   = document.getElementById('qqBuy');
  const feeBx = document.getElementById('qqFeeBox');

  adv.value = D.advance;
  adv.max   = String(D.advance);
  isoPt.value = String(D.isoPct);
  sell.value  = D.sellRate.toFixed(2);
  sell.min    = D.buyRate.toFixed(2);
  buy.value   = D.buyRate.toFixed(2);
  feeBx.value = String(fee3pct(D.advance));
  document.getElementById('qqHold').textContent = fmt0(D.holdback);

  const payOut = document.getElementById('qqPayback');
  const netOut = document.getElementById('qqNet');
  const isoOut = document.getElementById('qqIso');
  const qqPayAmt = document.getElementById('qqPayAmt');
  const qqTot    = document.getElementById('qqTot');
  const ppBody   = document.getElementById('qqPpBody');

  const seedRates = Array.isArray(D.prepayRates) ? D.prepayRates.slice(0, D.maxPrepayMonths||4) : [];
  const maxM = D.maxPrepayMonths || seedRates.length || 4;
  const sellBaseline = +D.sellRate.toFixed(2);
  const isoBaseline  = +D.isoPct.toFixed(0);

  let userEditingSell=false;
  sell.addEventListener('focus', ()=> userEditingSell=true );
  sell.addEventListener('blur',  ()=> { userEditingSell=false; if(+sell.value < +buy.value) sell.value = (+buy.value).toFixed(2); render(); });

  function render(){
    // Cap Advance to main page value
    let A = +adv.value || 0;
    if(A > D.advance){ A = D.advance; adv.value = String(D.advance); }

    let pct = Math.round(+isoPt.value || 0);
    if(pct<0) pct=0; if(pct>100) pct=100; isoPt.value = String(pct);

    // Fee locked to 3%
    const fee = fee3pct(A);
    feeBx.value = String(fee);

    // ISO↔Sell coupling (±0.01 per 1% change)
    const deltaPct = pct - isoBaseline;
    const coupledSell = +(sellBaseline + (deltaPct * 0.01)).toFixed(2);
    if(!userEditingSell){
      sell.value = Math.max(coupledSell, +buy.value).toFixed(2);
    } else {
      if(+sell.value < +buy.value) sell.value = (+buy.value).toFixed(2);
    }

    const sr = +sell.value || +buy.value || 1;
    const payback = A * sr;
    const iso$    = A * (pct/100);
    const net     = Math.max(0, A - fee - D.holdback);

    payOut.textContent = fmt(payback);
    isoOut.textContent = fmt(iso$);
    netOut.textContent = fmt(net);

    // Payment via basePeriods method if available; else fallback from monthsBase
    let paymentCalc = 0;
    if(Number.isFinite(D.basePeriods) && D.basePeriods>0){
      paymentCalc = payback / D.basePeriods;
    } else {
      const monthly = payback / Math.max(1, D.monthsBase || 1);
      const daily   = monthly / 21;
      const weekly  = daily * 5;
      paymentCalc   = (D.frequencyMain==='weekly') ? weekly : daily;
    }
    const payment = Math.max(1, Math.round(paymentCalc));
    let count=0, finalPay=0, monthsEst=0;
    if(payment>0 && payback>0){
      count = Math.ceil(payback / payment);
      finalPay = Math.max(0, Math.round(payback - payment*(count-1)));
      monthsEst = (D.frequencyMain==='weekly') ? ((payback/payment)/4.33) : ((payback/payment)/21);
    }
    qqPayAmt.textContent = payment>0 ? (fmt0(payment) + ' (final ' + fmt0(finalPay) + ')') : '$0';
    qqTot.textContent    = count ? (String(count) + ' (≈ ' + monthsEst.toFixed(2) + ' mo)') : '0';

    // Prepay scenarios: shift each month’s rate by deltaPct*0.01
    ppBody.innerHTML='';
    for(let m=1;m<=maxM;m++){
      const baseRate = +( (seedRates[m-1] ?? sr) );
      let rate = baseRate + (deltaPct * 0.01);
      if(rate < 1) rate = 1;
      const payoff = +(A * rate).toFixed(2);
      const disc   = +(payback - payoff).toFixed(2); // discount vs current gross payback
      const tr=document.createElement('tr');
      tr.innerHTML = '<td>Month '+m+'</td><td>'+fmt(disc)+'</td><td>'+fmt(payoff)+'</td><td>'+rate.toFixed(2)+'</td>';
      ppBody.appendChild(tr);
    }
  }

  ['input','change','blur'].forEach(ev=>{
    adv.addEventListener(ev, render);
    isoPt.addEventListener(ev, render);
    sell.addEventListener(ev, render);
  });

  document.getElementById('qqBack').addEventListener('click', ()=> window.close() );
  document.getElementById('qqPrint').addEventListener('click', ()=> window.print() );

  render();

  // Tiny guardrail
  try{
    const baseSR = sellBaseline, baseISO = isoBaseline;
    const newISO = baseISO + 2;
    const expectedSR = +(baseSR + 0.02).toFixed(2);
    const calcSR = +(baseSR + ((newISO-baseISO)*0.01)).toFixed(2);
    console.assert(calcSR===expectedSR, 'Sell should move 0.01 per +1% ISO');
  }catch(e){}
}
</script>
</body>
</html>