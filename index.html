<!-- =========================
FILE 1 of 2 — index.html
Adds:
• z-index fix for Payment Schedule modal (no bleed-through)
• Deal Notes textarea (included in linkable Quick Quote)
• Copy Quote Link still works from main page
• Payment Schedule modal preserved
========================= -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PWF — Internal Deal Calculator</title>
<style>
:root{ --gold:#d09c34; --bg:#101424; --panel:#12182c; --muted:#0f1426; --text:#ffffff; --sub:rgba(255,255,255,.70); --border:rgba(255,255,255,.10); --danger:#ff5a5a; --radius:16px; --shadow:0 12px 30px rgba(0,0,0,.35); }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
header{display:flex;gap:8px;align-items:center;justify-content:center;padding:12px;border-bottom:1px solid var(--border);color:var(--sub)}
.container{max-width:1280px;margin:20px auto 40px;padding:0 16px;display:grid;grid-template-columns:410px 1fr;gap:24px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
.card h2{margin:0;padding:16px 20px;border-bottom:1px solid var(--border);font-size:18px;display:flex;align-items:center;justify-content:space-between}
.card .content{padding:18px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
label{display:block;font-size:12px;color:var(--sub);margin:10px 0 6px}
input,select,textarea{width:100%;background:rgba(16,20,36,.6);border:1px solid var(--border);border-radius:10px;color:var(--text);padding:12px;font-size:14px;outline:none}
textarea{min-height:88px;resize:vertical}
input:focus,select:focus,textarea:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(208,156,52,.18)}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.stats4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.stat{background:var(--muted);border:1px solid var(--border);border-radius:14px;padding:14px;position:relative}
.stat .k{font-size:12px;color:var(--sub)}
.stat .v{font-size:18px;font-weight:700;margin-top:6px}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(16,20,36,.6);border:1px solid var(--border);color:var(--sub);font-size:12px}
.table-wrap{max-height:380px;overflow:auto;border:1px solid var(--border);border-radius:12px}
table{width:100%;border-collapse:collapse}
th,td{text-align:right;padding:10px 8px;border-bottom:1px solid var(--border);font-variant-numeric:tabular-nums}
th:first-child,td:first-child{text-align:left}
thead th{position:sticky;top:0;background:var(--panel);z-index:1}
.flex{display:flex;gap:10px;align-items:center;justify-content:space-between}
.btn{cursor:pointer;user-select:none;background:linear-gradient(180deg,var(--gold),#b5862e);color:#111;border:none;border-radius:10px;padding:10px 14px;font-weight:700;letter-spacing:.2px;box-shadow:0 8px 22px rgba(208,156,52,.28)}
.btn.sec{background:transparent;border:1px solid var(--border);color:var(--text);box-shadow:none}
.small{font-size:12px;color:var(--sub)}
.footer{text-align:center;color:var(--sub);font-size:12px;margin-top:20px}
@media(max-width:960px){.container{grid-template-columns:1fr}.stats,.stats4{grid-template-columns:1fr 1fr}}
@media print{ header{display:none}.btn{display:none}.card{box-shadow:none;border-color:#ddd} .pill{border-color:#ddd;color:#444;background:#fff}.table-wrap{max-height:unset;overflow:visible} body{background:#fff;color:#000} }

/* ===== Payment Schedule Modal + z-index fix ===== */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:10000 !important}
.modal.show{display:flex}
.modal-card{width:min(980px,95vw);max-height:90vh;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);position:relative;z-index:10001 !important}
.modal-card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:18px;display:flex;align-items:center;justify-content:space-between}
.modal-card .content{padding:16px}
</style>
</head>
<body>
<header>PWF — Internal Deal Calculator</header>

<div class="container">
  <!-- ================= LEFT: INPUTS ================= -->
  <div class="card">
    <h2>Deal Inputs <span class="pill" id="dealNameBadge">No Deal Name</span></h2>
    <div class="content">
      <div class="row">
        <div>
          <label>Deal Name</label>
          <input type="text" id="dealName" placeholder="e.g. PWF" />
        </div>
        <div>
          <label>Expiration Date</label>
          <input type="date" id="startDate" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Advance Amount ($)</label>
          <input type="number" id="advance" min="0" step="100" value="0" />
        </div>
        <div>
          <label>Periodic Payment ($)</label>
          <input type="number" id="periodicPay" min="1" step="1" placeholder="Enter weekly/daily payment" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Buy Rate (factor)</label>
          <input type="number" id="buyRate" min="1" step="0.01" value="1.30" />
        </div>
        <div>
          <label>Payment Frequency</label>
          <select id="frequency">
            <option value="daily">Daily (Business Days)</option>
            <option value="weekly" selected>Weekly</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Sell Rate (factor)</label>
          <input type="number" id="sellRate" inputmode="decimal" min="1" step="0.01" value="1.42" />
        </div>
        <div>
          <label>ISO Commission (%)</label>
          <input type="number" id="isoPts" min="0" max="100" step="1" value="12" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Fee ($)</label>
          <input type="number" id="feeBox" min="0" step="1" value="0" />
          <div class="small" style="margin-top:6px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" id="feeAuto" checked /> Auto-tier</label>
            <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" id="noFee" /> No fee</label>
            <span>Tier: $5k–9,999 → $350 • $10k–14,999 → $450 • $15k–18,999 → $550 • $19k+ → 3%</span>
          </div>
        </div>
        <div>
          <label>Holdback ($)</label>
          <input type="number" id="holdback" min="0" step="100" value="0" />
        </div>
      </div>

      <div style="margin-top:16px; border-top:1px solid var(--border); padding-top:12px;">
        <div class="flex" style="margin-bottom:8px;">
          <h3 style="margin:0; font-size:16px;">Prepay Settings</h3>
          <span class="pill">:)</span>
        </div>

        <div class="row">
          <div>
            <label>Months</label>
            <input type="number" id="maxPrepayMonths" min="1" max="12" step="1" value="4" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Template Month 1 Rate</label>
            <input type="number" id="tpl1" step="0.01" min="1" value="1.15" />
          </div>
          <div>
            <label>Template Month 2 Rate</label>
            <input type="number" id="tpl2" step="0.01" min="1" value="1.20" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Template Month 3 Rate</label>
            <input type="number" id="tpl3" step="0.01" min="1" value="1.25" />
          </div>
          <div>
            <label>Template Month 4 Rate</label>
            <input type="number" id="tpl4" step="0.01" min="1" value="1.30" />
          </div>
        </div>

        <div class="flex" style="gap:8px; margin-top:8px;">
          <button class="btn sec" id="applyTemplateBtn" type="button">Apply Template</button>
          <button class="btn sec" id="clearPrepayBtn" type="button">Reset</button>
        </div>

        <div class="table-wrap" style="margin-top:10px;">
          <table id="prepayRateTable">
            <thead><tr><th>Month</th><th>Sell Rate @ Month</th></tr></thead>
            <tbody id="prepayRateTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Notes shared in Quick Quote link -->
      <div style="margin-top:16px; border-top:1px solid var(--border); padding-top:12px;">
        <div class="flex" style="margin-bottom:6px;">
          <h3 style="margin:0; font-size:16px;">Quote Notes</h3>
          <span class="small">Included in link</span>
        </div>
        <label for="notes" class="small">Use this to leave notes for ISO about DL, VC, banks, etc..</label>
        <textarea id="notes" maxlength="800" placeholder="E.g. Please upload the last 3 months of bank statements and verify the outstanding tax lien balance."></textarea>
        <div class="small" id="notesCount" style="text-align:right;opacity:.75">0 / 800</div>
      </div>

      <div class="small" style="margin-top:10px;">PWF Calc</div>
    </div>
  </div>

  <!-- ================= RIGHT: SUMMARY ================= -->
  <div class="card">
    <h2 class="flex">Summary <span class="pill" id="validationMsg" aria-live="polite">Ready</span></h2>
    <div class="content">
      <div class="flex" style="margin-bottom:12px;gap:8px;justify-content:flex-end">
        <button class="btn sec" id="printBtn" type="button">Print</button>
        <button class="btn sec" id="copyLinkBtn" type="button">Copy Quote Link</button>
        <button class="btn sec" id="quickQuoteBtn" type="button">Quick Quote</button>
        <button class="btn" id="payScheduleBtn" type="button">Payment Schedule</button>
      </div>

      <div class="stats4">
        <div class="stat"><div class="k">Payback</div><div class="v" id="paybackEff">$0</div><div class="small">Advance × (Sell − ISO%)</div></div>
        <div class="stat"><div class="k">Merchant Payback</div><div class="v" id="merchantPaybackGross">$0</div><div class="small">Advance × Sell Rate</div></div>
        <div class="stat"><div class="k">Funder Payback</div><div class="v" id="funderPayback">$0</div><div class="small">Advance × Buy Rate</div></div>
        <div class="stat"><div class="k">ISO Commission $</div><div class="v" id="grossSpread">$0</div><div class="small">ISO % × Advance</div></div>
      </div>

      <div class="stats" style="margin-top:12px;">
        <div class="stat"><div class="k">Payment Amount</div><div class="v" id="paymentAmount">$0</div><div class="small"><span id="freqLabel">Weekly</span> fixed (Final included)</div></div>
        <div class="stat"><div class="k">Total Payments</div><div class="v" id="totalPayments">0</div><div class="small">Count + months (MP ÷ pay ÷ 21/4.33)</div></div>
        <div class="stat"><div class="k">Net Funded</div><div class="v" id="netFunded">$0</div><div class="small">Advance − Fee − Holdback</div></div>
      </div>

      <div style="margin-top:18px;">
        <div class="flex" style="margin-bottom:8px;">
          <h3 style="margin:0; font-size:16px;">Prepay Scenarios (Adjustable)</h3>
          <span class="pill">Months: <span id="ppMonthsLabel">4</span></span>
        </div>
        <div class="table-wrap">
          <table id="prepayScenarios">
            <thead><tr><th>Scenarios</th><th>Estimated Discount</th><th>Payoff</th><th>Sell Rate</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="footer">PWF — Internal Calculator (Standalone HTML)</div>
    </div>
  </div>
</div>

<!-- Payment Schedule Modal -->
<div class="modal" id="scheduleModal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="schedTitle">
    <h3 id="schedTitle">Payment Schedule
      <span class="pill" id="schedMeta"></span>
      <div class="flex" style="gap:8px">
        <button class="btn sec" id="downloadCsvBtn" type="button">Download CSV</button>
        <button class="btn sec" id="printScheduleBtn" type="button">Print</button>
        <button class="btn" id="closeSchedule" type="button">Close</button>
      </div>
    </h3>
    <div class="content">
      <div class="row" style="margin-bottom:8px">
        <div>
          <label>First Due Date</label>
          <input type="date" id="firstDueDate" />
        </div>
        <div>
          <label>Frequency</label>
          <input id="freqDisplay" disabled />
        </div>
      </div>
      <div class="table-wrap">
        <table id="scheduleTable">
          <thead><tr><th>#</th><th>Due Date</th><th>Amount</th><th>Running Balance</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="small" style="margin-top:8px" id="schedFoot"></div>
    </div>
  </div>
</div>

<script src="./codec.js"></script>
<script>
'use strict';
// ===== Helpers =====
const byId = (id)=>document.getElementById(id);
const fmt  = (n)=> n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
const fmt0 = (n)=> n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
const toLocalISO=(date)=>{const d=new Date(date);const tz=d.getTimezoneOffset();const local=new Date(d.getTime()-tz*60000);return local.toISOString().slice(0,10);};
const monthAheadISO=()=>{const d=new Date();d.setMonth(d.getMonth()+1);return toLocalISO(d);};

function setDefaultStartDate(){ const el=byId('startDate'); if(el && !el.value){ el.value = monthAheadISO(); } }

// ===== Fee logic =====
function autoTierFee(advance){
  const A=+advance||0; if(A<=0) return 0;
  if(A<=9999) return 350;
  if(A<=14999) return 450;
  if(A<=18999) return 550;
  return +(A*0.03).toFixed(2);
}
function currentFee(advance){
  if(byId('noFee')?.checked) return 0;
  if(byId('feeAuto')?.checked) return autoTierFee(advance);
  const manual = +byId('feeBox').value || 0;
  return Math.max(0, manual);
}
function syncFeeBox(advance){
  const feeInput = byId('feeBox');
  const auto=byId('feeAuto')?.checked, no=byId('noFee')?.checked;
  if(no){ feeInput.value='0'; feeInput.disabled=true; }
  else if(auto){ feeInput.value=String(autoTierFee(advance)); feeInput.disabled=true; }
  else { feeInput.disabled=false; }
}

// ===== Prepay UI =====
function rebuildPrepayRateRows(){
  const maxM = Math.max(1, Math.min(12, +(byId('maxPrepayMonths').value) || 4));
  byId('ppMonthsLabel').textContent = String(maxM);
  const tb = byId('prepayRateTbody'); tb.innerHTML='';
  for(let i=1;i<=maxM;i++){
    const tr=document.createElement('tr');
    tr.innerHTML = '<td>'+i+'</td><td><input data-month="'+i+'" class="prepayRate" type="number" step="0.01" min="1" /></td>';
    tb.appendChild(tr);
  }
}
function getPrepayRates(defaultSell){
  const maxM = Math.max(1, Math.min(12, +(byId('maxPrepayMonths').value) || 4));
  const inputs = Array.from(document.querySelectorAll('input.prepayRate'));
  const rates=[];
  for(let i=0;i<maxM;i++){
    const raw=inputs[i]?.value; const v = raw===''||raw===undefined ? NaN : +raw;
    rates.push(Number.isFinite(v)? v : defaultSell);
  }
  return {rates, maxM};
}
function applyTemplateRates(){
  const sell = +(byId('sellRate').value)||1.30;
  const maxM = Math.max(1, Math.min(12, +(byId('maxPrepayMonths').value)||4));
  const tpl=[ +(byId('tpl1').value)||1.15, +(byId('tpl2').value)||1.20, +(byId('tpl3').value)||1.25, +(byId('tpl4').value)||1.30 ];
  const inputs = Array.from(document.querySelectorAll('input.prepayRate'));
  for(let i=0;i<maxM;i++){
    const v = (i<tpl.length && typeof tpl[i]==='number') ? tpl[i] : sell;
    if(inputs[i]) inputs[i].value = (+v).toFixed(2);
  }
  updateAll();
}
function clearPrepayRates(){ document.querySelectorAll('input.prepayRate').forEach(el=>{ el.value=''; }); updateAll(); }
function renderPrepayScenarios({advance, sellRate, merchantPayback}){
  const {rates,maxM} = getPrepayRates(sellRate);
  const tbody = byId('prepayScenarios').querySelector('tbody'); tbody.innerHTML='';
  for(let m=1;m<=maxM;m++){
    const rawRate = rates[m-1] || sellRate; const payoff = +(advance * rawRate).toFixed(2); const discount= +(merchantPayback - payoff).toFixed(2);
    const tr=document.createElement('tr'); tr.innerHTML = '<td>If Paid off in Month '+m+'</td><td>'+fmt(discount)+'</td><td>'+fmt(payoff)+'</td><td>'+rawRate.toFixed(2)+'</td>'; tbody.appendChild(tr);
  }
}

// ===== Core Recalc =====
function updateAll(){
  const name=(byId('dealName')?.value||'').trim();
  const badge=byId('dealNameBadge'); if(badge) badge.textContent = name || 'No Deal Name';
  if(name) document.title = 'Pac Western Deal — '+name;

  setDefaultStartDate();
  const advance   = +byId('advance').value || 0;
  const buyRate   = +byId('buyRate').value || 1.20;
  const sellInput = byId('sellRate');
  let   sellRate  = +sellInput.value || buyRate; if(sellRate < buyRate) sellRate = buyRate;

  const isoRaw = +byId('isoPts').value || 0; const isoPctUsed= Math.round(isoRaw);
  const holdback  = +byId('holdback').value || 0;
  const frequency = byId('frequency')?.value || 'weekly';
  const periodicPay = Math.max(0, Math.floor(+byId('periodicPay').value || 0));

  syncFeeBox(advance); const fee = currentFee(advance);

  let msg='Ready';
  if(advance<=0) msg='Advance must be > 0';
  else if(periodicPay<=0) msg='Enter periodic payment > 0';
  if(fee+holdback>advance) msg='Fee/Holdback exceed advance';
  const tag=byId('validationMsg'); if(tag){ tag.textContent=msg; tag.style.color=(msg==='Ready'?'var(--sub)':'var(--danger)'); }

  const effectiveSell = Math.max(0, sellRate - (isoPctUsed/100));
  const merchantPaybackGross = advance * sellRate;
  const paybackEff = advance * effectiveSell;
  const funderPayback = advance * buyRate;
  const isoCommission = advance * (isoPctUsed/100);
  const netFunded = Math.max(0, advance - fee - holdback);

  byId('paybackEff').textContent = fmt(paybackEff);
  byId('merchantPaybackGross').textContent = fmt(merchantPaybackGross);
  byId('funderPayback').textContent = fmt(funderPayback);
  byId('grossSpread').textContent = fmt(isoCommission);
  byId('netFunded').textContent = fmt(netFunded);

  const freqLabel = (frequency.charAt(0).toUpperCase()+frequency.slice(1)); byId('freqLabel').textContent = freqLabel;

  let totalPayments = 0, finalPayment = 0;
  if(periodicPay>0 && merchantPaybackGross>0){ totalPayments = Math.ceil(merchantPaybackGross / periodicPay); finalPayment  = Math.max(0, Math.round(merchantPaybackGross - periodicPay*(totalPayments-1))); }
  byId('paymentAmount').textContent = (periodicPay>0) ? (fmt0(periodicPay) + ' (final ' + fmt0(finalPayment) + ')') : '$0';

  let months = 0; if(periodicPay>0){ if(frequency==='weekly') months = (merchantPaybackGross / periodicPay) / 4.33; else if(frequency==='daily') months = (merchantPaybackGross / periodicPay) / 21; }
  byId('totalPayments').textContent = String(totalPayments) + (totalPayments ? (' (≈ ' + months.toFixed(2) + ' mo)') : '');

  renderPrepayScenarios({advance,sellRate,merchantPayback:merchantPaybackGross});
  // Update notes counter
  const n = (byId('notes').value||'').length; byId('notesCount').textContent = `${n} / 800`;
}

// ===== Quick Quote link (build + copy on MAIN PAGE) =====
function gatherQuickQuoteData(){
  const {rates,maxM} = getPrepayRates(+byId('sellRate').value || 1.3);
  const data = {
    name: byId('dealName').value || '',
    advance: +byId('advance').value || 0,
    sellRate: Math.max(+byId('sellRate').value || 0, +byId('buyRate').value || 0),
    buyRate: +byId('buyRate').value || 0,
    isoPct: Math.round(+byId('isoPts').value || 0),
    holdback: +byId('holdback').value || 0,
    expDateISO: byId('startDate').value || monthAheadISO(),
    periodicPayMain: Math.max(0, Math.floor(+byId('periodicPay').value || 0)),
    frequencyMain: byId('frequency').value || 'weekly',
    prepayRates: rates,
    maxPrepayMonths: maxM,
    notes: (byId('notes').value||'').trim(),
  };
  const paybackMain = data.advance * data.sellRate;
  data.monthsBase = (() => {
    if(data.periodicPayMain>0){ if(data.frequencyMain==='weekly') return (paybackMain / data.periodicPayMain) / 4.33; if(data.frequencyMain==='daily') return (paybackMain / data.periodicPayMain) / 21; }
    return 1;
  })();
  data.basePeriods = (data.periodicPayMain>0 && paybackMain>0) ? (paybackMain / data.periodicPayMain) : NaN;
  return data;
}
function makeQuoteURL(){
  const data = gatherQuickQuoteData(); if(data.advance<=0) throw new Error('Advance must be > 0');
  const encoded = (window.Codec? Codec.encode(JSON.stringify(data)) : encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(data))))));
  const url = new URL('./quick-quote.html', location.href); url.searchParams.set('q', encoded); return url.toString();
}
async function copyQuoteLink(){
  try{
    const url = makeQuoteURL();
    // Warn on very long links (notes too long)
    if(url.length>1900){ byId('validationMsg').textContent='Heads up: link is long; consider shortening notes.'; }
    try{ await navigator.clipboard.writeText(url); }
    catch(_){ const ta=document.createElement('textarea'); ta.value=url; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.focus(); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
    byId('validationMsg').textContent='Link copied';
  }catch(e){ byId('validationMsg').textContent=e.message||'Unable to copy link'; }
}
function openQuickQuote(){ try{ const url = makeQuoteURL(); window.open(url, '_blank'); } catch(e){ byId('validationMsg').textContent=e.message||'Unable to open quote'; } }

// ===== Payment Schedule =====
function isWeekend(d){ const day=d.getDay(); return day===0||day===6; }
function nextBizDay(from){ const d=new Date(from); d.setDate(d.getDate()+1); while(isWeekend(d)) d.setDate(d.getDate()+1); return d; }
function adjustIfWeekend(d){ const x=new Date(d); while(isWeekend(x)) x.setDate(x.getDate()+1); return x; }
function addBizDays(start, n){ const d=new Date(start); let added=0; while(added<n){ d.setDate(d.getDate()+1); if(!isWeekend(d)) added++; } return d; }
function openSchedule(){
  const advance=+byId('advance').value||0; const sell=Math.max(+byId('sellRate').value||0, +byId('buyRate').value||0); const payback=advance*sell; const pay=Math.max(0, Math.floor(+byId('periodicPay').value||0)); const freq=(byId('frequency').value||'weekly');
  if(advance<=0 || pay<=0){ byId('validationMsg').textContent='Enter advance and payment first'; return; }
  const count=Math.ceil(payback/pay); const finalPay=Math.max(0, Math.round(payback - pay*(count-1)));
  const modal=byId('scheduleModal'); const firstDue=byId('firstDueDate'); const freqDisp=byId('freqDisplay'); const meta=byId('schedMeta'); const foot=byId('schedFoot');
  if(!firstDue.value){ firstDue.value = toLocalISO(nextBizDay(new Date())); }
  freqDisp.value = (freq==='weekly'?'Weekly':'Daily (Biz)'); meta.textContent = `${count} payments • ${fmt0(pay)} (final ${fmt0(finalPay)})`;
  const build=()=>{
    const tbody=byId('scheduleTable').querySelector('tbody'); tbody.innerHTML=''; const start=new Date(firstDue.value || toLocalISO(nextBizDay(new Date()))); let due=new Date(start); let remaining=Math.round(payback);
    for(let i=1;i<=count;i++){
      const amt=(i<count)? Math.round(pay) : Math.round(finalPay||pay); remaining = Math.max(0, remaining-amt); const tr=document.createElement('tr'); tr.innerHTML = `<td>${i}</td><td>${toLocalISO(due)}</td><td>${fmt0(amt)}</td><td>${fmt0(remaining)}</td>`; tbody.appendChild(tr);
      if(freq==='weekly'){ due.setDate(due.getDate()+7); due=adjustIfWeekend(due); } else { due = addBizDays(due,1); }
    }
    foot.textContent = `Total scheduled: ${count} payments = ${fmt0(Math.round(pay)*(count-1) + Math.round(finalPay||pay))}`;
  };
  build(); firstDue.addEventListener('change', build); modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
}
function closeSchedule(){ const modal=byId('scheduleModal'); modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }
function downloadCSV(){ const table=byId('scheduleTable'); const rows=[["#","Due Date","Amount","Running Balance"]]; for(const tr of table.querySelectorAll('tbody tr')){ const tds=[...tr.children].map(td=>td.textContent.replace(/[$,]/g,'')); rows.push(tds); } const csv = rows.map(r=>r.join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='payment-schedule.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000); }

// ===== Wire up =====
window.addEventListener('DOMContentLoaded', ()=>{
  setDefaultStartDate(); rebuildPrepayRateRows(); applyTemplateRates(); updateAll();
  const ids=['dealName','advance','buyRate','sellRate','isoPts','holdback','frequency','startDate','maxPrepayMonths','tpl1','tpl2','tpl3','tpl4','periodicPay','noFee','feeAuto','feeBox','notes'];
  ids.forEach(id=>{ const el=byId(id); if(!el) return; ['input','change','keyup','blur'].forEach(ev=> el.addEventListener(ev, ()=>{ if(id==='maxPrepayMonths'){ rebuildPrepayRateRows(); applyTemplateRates(); } updateAll(); })); });
  document.addEventListener('input', (e)=>{ if(e.target && e.target.classList.contains('prepayRate')) updateAll(); });
  byId('sellRate').addEventListener('blur', ()=>{ const br=+byId('buyRate').value||0; let v=parseFloat(byId('sellRate').value); if(!Number.isFinite(v)) v=br; if(v<br) v=br; byId('sellRate').value=v.toFixed(2); updateAll(); });
  byId('printBtn').addEventListener('click', (e)=>{ e.preventDefault(); window.print(); });
  byId('quickQuoteBtn').addEventListener('click', (e)=>{ e.preventDefault(); openQuickQuote(); });
  byId('copyLinkBtn').addEventListener('click', (e)=>{ e.preventDefault(); copyQuoteLink(); });
  byId('payScheduleBtn').addEventListener('click', (e)=>{ e.preventDefault(); openSchedule(); });
  byId('closeSchedule').addEventListener('click', (e)=>{ e.preventDefault(); closeSchedule(); });
  byId('downloadCsvBtn').addEventListener('click', (e)=>{ e.preventDefault(); downloadCSV(); });
  byId('printScheduleBtn').addEventListener('click', (e)=>{ e.preventDefault(); window.print(); });
});
</script>
</body>
</html>